---
// This frontmatter is intentionally empty.
// The WeatherData interface is defined and used in the client-side script below.
---

<div id="weather" style="text-align: center;">
  <p>Loading weather...</p>
</div>

<style>
  #weather {
    font-size: 0.8rem;
  }
  #weather p {
    margin: 0.2em 0;
  }
</style>

<script>
  interface WeatherData {
    lat: number;
    lon: number;
    timezone: string;
    timezone_offset: number;
    current: {
      dt: number;
      sunrise: number;
      sunset: number;
      temp: number;
      feels_like: number;
      pressure: number;
      humidity: number;
      dew_point: number;
      uvi: number;
      clouds: number;
      visibility: number;
      wind_speed: number;
      wind_deg: number;
      wind_gust: number;
      weather: {
        id: number;
        main: string;
        description: string;
        icon: string;
      }[];
    };
  }

  async function fetchWeather() {
    const weatherElement = document.getElementById("weather");
    try {
      const response = await fetch("https://store.332712.xyz/weather.json");
      if (!response.ok) {
        throw new Error(`Failed to fetch: ${response.statusText}`);
      }
      const data: WeatherData = await response.json();
      const currentWeather = data.current;
      const dt = new Date(currentWeather.dt * 1000).toLocaleString();
      const sunrise = new Date(
        currentWeather.sunrise * 1000
      ).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
      const sunset = new Date(currentWeather.sunset * 1000).toLocaleTimeString(
        [],
        {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        }
      );
      const temperature = currentWeather.temp;
      const feelsLike = currentWeather.feels_like;
      const pressure = currentWeather.pressure;
      const humidity = currentWeather.humidity;
      const dewPoint = currentWeather.dew_point;
      const uvi = currentWeather.uvi;
      const clouds = currentWeather.clouds;
      const visibility = currentWeather.visibility;
      const windSpeed = currentWeather.wind_speed;
      const windDeg = currentWeather.wind_deg;
      const windGust = currentWeather.wind_gust;
      let weatherDescription = "晴天";
      let weatherIconRaw = "01d";
      let weatherIcon = "01d"; // Use a default icon code
      if (
        Array.isArray(currentWeather.weather) &&
        currentWeather.weather.length > 0 &&
        typeof currentWeather.weather[0] === "object"
      ) {
        weatherDescription = currentWeather.weather[0].description;
        weatherIconRaw = currentWeather.weather[0].icon;
        // Validate icon code: should be 2 digits + 'd' or 'n' (e.g. 01d, 02n, 10d, etc.)
        weatherIcon = /^[0-9]{2}[dn]$/.test(weatherIconRaw)
          ? weatherIconRaw
          : "01d";
      }
      const iconUrl = `https://openweathermap.org/img/wn/${weatherIcon}@2x.png`;

      if (weatherElement) {
        weatherElement.innerHTML = ""; // Clear previous contents
        const p = document.createElement("p");

        const iconImg = `<img src="${iconUrl}" alt="${weatherDescription}" width="30" height="30">`;

        p.innerHTML = `
          <span style="display: inline-flex; align-items: center; justify-content: center; gap: 1em;">
            <span><b>現在の天気</b></span>
            <span>時刻: ${dt} (UTC+9)</span>
          </span><br>
          <span style="display: inline-flex; align-items: center; justify-content: center; gap: 1em;">
            <span>${iconImg}</span>
            <span><b>${temperature}°C</b></span>
            <span><b>${weatherDescription}</b></span>
          </span><br>
          <span style="display: inline-flex; align-items: center; justify-content: center; gap: 1em;">
            <span>体感温度: ${feelsLike}°C</span>
            <span>紫外線指数: ${uvi}</span>
          </span><br>
          <span style="display: inline-flex; align-items: center; justify-content: center; gap: 1em;">
            <span>気圧: ${pressure} hPa</span>
            <span>湿度: ${humidity}%</span>
            <span>露点: ${dewPoint}°C</span>
          </span><br>
          <span style="display: inline-flex; align-items: center; justify-content: center; gap: 1em;">
            <span>雲量: ${clouds}%</span>
            <span>視程: ${visibility}m</span>
          </span><br>
          <span style="display: inline-flex; align-items: center; justify-content: center; gap: 1em;">
            <span>風速: ${windSpeed} m/s</span>
            <span>風向: ${windDeg}°</span>
            <span>最大瞬間風速: ${windGust !== undefined ? windGust : "N/A"} m/s</span>
          </span><br>
          <span style="display: inline-flex; align-items: center; justify-content: center; gap: 1em;">
            <span>日の出: ${sunrise}</span>
            <span>日の入り: ${sunset}</span>
          </span>
        `;

        weatherElement.appendChild(p);
      }
    } catch (error) {
      if (weatherElement) {
        // Clear previous contents
        weatherElement.textContent = "";
        const errorP = document.createElement("p");
        errorP.textContent =
          "Could not fetch weather. Please check your connection, or try again later.";
        weatherElement.appendChild(errorP);
      }
      console.error("Failed to fetch weather:", error);
    }
  }

  fetchWeather();
  setInterval(fetchWeather, 600000); // 10 minutes
</script>
